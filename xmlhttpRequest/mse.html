<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <script>


        var assetURL = 'http://localhost/phpStudy/xmlhttprequest/15346515019356_origin.mp4';
    // Need to be specific for Blink regarding codecs
    // ./mp4info frag_bunny.mp4 | grep Codec
    var mimeCodec = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';
    var reader;
    var mediaSource;
    var posStart = 0;
    var posEnd = 1024;
    var nIndex = 0;

    function openFile() {
        var video = document.getElementById("video");
        mediaSource = new MediaSource();
        if ('MediaSource' in window && MediaSource.isTypeSupported(mimeCodec)) {

            //console.log(mediaSource.readyState); // closed
            mediaSource.addEventListener('sourceopen', sourceOpen);

            video.src = URL.createObjectURL(mediaSource);
        } else {
            console.error('Unsupported MIME type or codec: ', mimeCodec);
        }
    }

    function sourceOpen() {
        console.log(this.readyState); // open
        var mediaSource = this;
        mediaSource.duration = 10;
        var sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);
        sourceBuffer.addEventListener('update', function () {
            console.log("update  " + mediaSource.readyState);
        });
        sourceBuffer.addEventListener('updatestart', function () {
            console.log("updatestart  " + mediaSource.readyState);
        });
        sourceBuffer.addEventListener('error', function () {
            console.log("error  " + mediaSource.readyState);
        });
        sourceBuffer.addEventListener('updateend', function () {
            console.log("updateend  " + mediaSource.readyState);

         //   posStart = posEnd;
            //   posEnd += 1205;
            if (nIndex >= 250) {
                mediaSource.endOfStream();
                video.play();
            } else {
                fetchAB(assetURL, null);
            }
            console.log(mediaSource.readyState); // ended
        });
        fetchAB(assetURL, function (buf) {
        // getFromFile(function (buf) {
            console.log(mediaSource.readyState);

            console.log(buf.byteLength);
            console.log(sourceBuffer.updating);


            var buff = new Int32Array(buf, 0, 4);
            console.log(buff.toString());
            console.log(buff[0]);

            mediaSource.sourceBuffers[0].appendBuffer(buf);
            console.log(mediaSource.readyState);
        });

    };

    function fetchAB(url, cb) {
       // console.log(url);
        var xhr = new XMLHttpRequest;
        xhr.open('get', url);
        xhr.setRequestHeader("Range", "bytes="+posStart + "-" + posEnd);
        xhr.responseType = 'arraybuffer';
        xhr.onreadystatechange = function () {
            if (xhr.readyState < 4)
                return;

            var buff = new Uint8Array(xhr.response, 0, 16);
           // console.log(posStart + " " + xhr.response.byteLength + " " + buff.toString());
 
            var nSize = buff[0] * 0XFFFFFF + buff[1] * 65535 + buff[2] * 256 + buff[3];
            console.log(posStart + " " + nSize + "  " + nIndex);

            posStart += nSize;
            posEnd = posStart + 40920;
            nIndex++;

            //cb(xhr.response);
           // var data = new Int8Array(xhr.response, 0, nSize - 1);
            // console.log(data.toString());
            var data = xhr.response.slice(0, nSize - 1);
            mediaSource.sourceBuffers[0].appendBuffer(data);

        };
        xhr.send();
    };

    function getFromFile(cb) {
        var file = document.getElementById("file").files[0];
        reader = new FileReader();
        reader.readAsArrayBuffer(file);
        reader.onload = function (f) {
            console.log(this.result.byteLength);
           // cb(this.result);
        }
    }

    function playfile() {
        console.log(mediaSource.readyState);
        mediaSource.endOfStream();
        video.play();
    }

    function addBuff() {
        //      mediaSource.sourceBuffers[0].appendBuffer(reader.result);
        var file = document.getElementById("file").files[0];
        reader = new FileReader();
        reader.readAsArrayBuffer(file);
        reader.onload = function (f) {
            console.log(this.result.byteLength);
            // cb(this.result);
            console.log(this.result.toString());
            mediaSource.sourceBuffers[0].appendBuffer(this.result);
        }

    }
    </script>

</head>
<body>
    <video id ="video" width="320" height="240" controls autoplay >
        <!--source src="video.mp4" type="video/mp4"-->
    </video> <br />
    <input type="button" onclick="openFile()" value="play" /> <br />
    <input type="button" onclick="addBuff()" value="buff" /> <br />
   <input type="file" id="file" />   

    <script>
        openFile();
    </script>

</body>
</html>